<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>[Admin] Weekly Return XX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* === Base layout === */
    :root {
      --bg-gradient: linear-gradient(135deg, #1b1f3b, #42275a, #734b6d);
      --card-bg: #ffffff;
      --card-muted-bg: #f5f6fb;
      --border-subtle: rgba(0,0,0,0.06);
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.08);
      --radius-lg: 22px;
      --radius-md: 12px;
      --shadow-lg: 0 22px 45px rgba(15, 23, 42, 0.38);
      --shadow-soft: 0 12px 24px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
    margin: 0;
    min-height: 100vh;
    padding: 32px 16px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    color: var(--text-main);
    /* no background here */
    }
    body::before {
    content: "";
    position: fixed;
    inset: 0;
    background: url("vets_background.iX1Xh3mM_vEpn4.webp") center/cover no-repeat fixed;
    z-index: -2;
    }
    .page-shell {
    width: min(1120px, 100%);
    background: rgba(255,255,255,0.55); /* light translucent white */
    backdrop-filter: blur(18px) saturate(140%);
    border-radius: 32px;
    padding: 10px;
    box-shadow: 0 18px 35px rgba(0,0,0,0.20);
    border: 1px solid rgba(255,255,255,0.65);
    }

    .page {
      border-radius: 24px;
      padding: 24px 24px 28px;
      background: radial-gradient(circle at top, rgba(255,255,255,0.2), rgba(255,255,255,0.92));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.35);
    }

    h1 {
      font-size: 1.8rem;
      margin: 0 0 4px;
      letter-spacing: 0.03em;
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .cards {
      display: flex;
      flex-direction: column;
      gap: 22px;
      margin-top: 22px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 18px 18px 22px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-subtle);
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 1.15rem;
    }

    /* === Table-like layout === */
    .table {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .table-row {
      background: var(--card-muted-bg);
      border-radius: var(--radius-md);
      padding: 14px 14px 16px;
      border: 1px solid rgba(148,163,184,0.32);
    }

    .table-header {
      display: grid;
      grid-template-columns: 0.67fr 1.50fr 1.43fr 1.2fr 1.4fr;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      padding: 0 4px 6px;
      border-bottom: 1px solid rgba(148,163,184,0.55);
      margin-bottom: 4px;
    }

    .no-data {
      padding: 8px 0;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    /* === Day config layout === */
    .day-config-row {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      align-items: flex-start;
    }

    .day-config-col {
      flex: 1 1 260px;
      min-width: 240px;
    }

    .day-config-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      margin-bottom: 0.6rem;
    }

    .day-config-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 0.35rem;
    }

    .day-config-image-preview {
      max-width: 260px;
      border-radius: 10px;
      margin-top: 0.5rem;
      display: block;
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.28);
      border: 1px solid rgba(148,163,184,0.6);
    }

    /* === Inputs & buttons === */
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 7px 8px;
      border-radius: 9px;
      border: 1px solid rgba(148,163,184,0.7);
      font: inherit;
      color: var(--text-main);
      background: rgba(255,255,255,0.96);
      outline: none;
      transition: box-shadow 0.15s ease, border-color 0.15s ease, background 0.15s ease;
    }

    input::placeholder {
      color: rgba(148,163,184,0.9);
    }

    input:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft), 0 0 0 2px rgba(37,99,235,0.25);
      background: #fff;
    }

    label {
      font-size: 0.85rem;
      color: var(--text-main);
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      background: var(--accent);
      color: #fff;
      box-shadow: 0 8px 18px rgba(37,99,235,0.3);
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
    }

    button:hover {
      background: #1d4ed8;
      box-shadow: 0 10px 22px rgba(37,99,235,0.4);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(37,99,235,0.35);
    }

    .button-ghost {
      background: rgba(37,99,235,0.06);
      color: var(--accent);
      box-shadow: none;
    }

    .button-ghost:hover {
      background: rgba(37,99,235,0.14);
      box-shadow: none;
    }

    .coord-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .coord-row > div,
    .coord-row > input {
      flex: 1 1 70px;
    }

    .coord-row label {
      display: block;
      margin-bottom: 2px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(15,23,42,0.04);
      border: 1px solid rgba(148,163,184,0.6);
      color: var(--text-muted);
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34,197,94,0.3);
    }

    .msg {
      margin-top: 8px;
      font-size: 0.8rem;
    }

    .open-player-btn {
        display: inline-block;
        margin-top: 12px;
        padding: 8px 16px;
        background: #85eb25cc;
        color: #242a64;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 600;
        border-radius: 999px;
        box-shadow: 0 6px 14px rgba(37,99,235,0.25);
        transition: 0.15s ease;
    }

    .open-player-btn:hover {
        background: #b0ffceb6;
        box-shadow: 0 8px 18px rgba(37,99,235,0.35);
    }
  </style>
</head>

<!-- Auth guard -->
<script type="module">
  import { protectPage } from "./auth.js";
  protectPage();
</script>

<body>
  <div class="page-shell">
    <div class="page">
      <header style="display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;">
        <div>
          <h1>[ADMIN] Weekly Return XX</h1>
          <p class="muted">
            Unlock days, set answers, paste screenshot URLs, and review all player guesses.
          </p>
            <a href="return_week_xx.html" target="_blank" class="open-player-btn">
            Check Live Page
            </a>
        </div>
        <div class="badge">
          <span class="badge-dot"></span>
          Staff tools
        </div>
      </header>

      <div class="cards">
        <!-- Day configuration -->
        <section class="card">
          <h2>Day Configuration</h2>
          <p class="muted" style="margin-bottom:10px;">
            For each day, unlock it, set the correct coordinates, and paste a public image URL.
          </p>
          <div id="dayConfigList" class="table"></div>
          <p class="muted msg" id="dayConfigMessage"></p>
        </section>

        <!-- Entries viewer -->
        <section class="card">
          <h2>User Entries</h2>
          <label for="entriesDaySelect" class="day-config-label">Select day</label>
          <select id="entriesDaySelect" style="max-width:220px;margin-bottom:8px;"></select>
          <div id="entriesTable" class="table" style="margin-top:4px;"></div>
        </section>

        <!-- Distance calculator -->
        <section class="card">
          <h2>Distance Calculator</h2>
          <p class="muted" style="margin-bottom:10px;">
            Manually test a guess against the stored correct answer for any day.
          </p>

          <form id="distanceForm" style="display:flex;flex-direction:column;gap:8px;max-width:420px;">
            <div>
              <label for="calcDaySelect" class="day-config-label">Select</label>
              <select id="calcDaySelect" style="max-width:220px;"></select>
            </div>

            <div>
              <div class="day-config-label">Guess coordinates (x, y, z)</div>
              <div class="coord-row">
                <div>
                  <label for="calcX">X</label>
                  <input id="calcX" type="number" required />
                </div>
                <div>
                  <label for="calcY">Y</label>
                  <input id="calcY" type="number" required />
                </div>
                <div>
                  <label for="calcZ">Z</label>
                  <input id="calcZ" type="number" required />
                </div>
              </div>
            </div>

            <button type="submit" style="align-self:flex-start;margin-top:4px;">Calculate distance</button>
          </form>

          <p id="distanceResult" class="muted msg"></p>
        </section>
      </div>
    </div>
  </div>

  <!-- Firebase + admin logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      update,
      get
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBNS9RtaA1vpzwu8jGQ15jgpNN3UYl4rlw",
      authDomain: "wynnvets.firebaseapp.com",
      projectId: "wynnvets",
      storageBucket: "wynnvets.firebasestorage.app",
      messagingSenderId: "919163929856",
      appId: "1:919163929856:web:1042d6daa029dc11445fe5",
      measurementId: "G-KT2LYJ42H5"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const DAY_IDS = ["day1","day2","day3","day4","day5","day6","day7"];

    const dayConfigList   = document.getElementById("dayConfigList");
    const dayConfigMsg    = document.getElementById("dayConfigMessage");

    const entriesDaySelect = document.getElementById("entriesDaySelect");
    const entriesTable     = document.getElementById("entriesTable");

    const calcDaySelect = document.getElementById("calcDaySelect");
    const distanceForm  = document.getElementById("distanceForm");
    const distanceResult = document.getElementById("distanceResult");

    let daysCache = {};
    let entriesCache = {};

    function labelForDay(dayId) {
      const idx = DAY_IDS.indexOf(dayId);
      return idx === -1 ? dayId : `Day ${idx + 1}`;
    }

    function distance3D(a, b) {
      const dx = a.x - b.x;
      const dy = a.y - b.y;
      const dz = a.z - b.z;
      return Math.sqrt(dx*dx + dy*dy + dz*dz);
    }

    function fillDaySelects() {
      [entriesDaySelect, calcDaySelect].forEach(select => {
        select.innerHTML = "";
        DAY_IDS.forEach(dayId => {
          const opt = document.createElement("option");
          opt.value = dayId;
          opt.textContent = labelForDay(dayId);
          select.appendChild(opt);
        });
      });
    }
    fillDaySelects();

    /* ---------- DAY CONFIG RENDER ---------- */

    function renderDayConfig() {
      dayConfigList.innerHTML = "";

      DAY_IDS.forEach(dayId => {
        const data = daysCache[dayId] || {};
        const answer = data.answer || {};
        const imageUrl = data.imageUrl || "";
        const unlocked = !!data.unlocked;

        const row = document.createElement("div");
        row.className = "table-row";

        row.innerHTML = `
          <div class="day-config-row">
            <!-- LEFT COLUMN -->
            <div class="day-config-col">
              <div class="day-config-header">
                <strong>${labelForDay(dayId)}</strong>
                <label style="display:flex;align-items:center;gap:0.35rem;font-size:0.85rem;">
                  <input type="checkbox" class="day-unlock" data-day="${dayId}" ${unlocked ? "checked" : ""}>
                  <span>Unlock</span>
                </label>
              </div>

              <div>
                <div class="day-config-label">Correct answer (x, y, z)</div>
                <div class="coord-row">
                  <input class="answer-x" data-day="${dayId}" type="number" value="${answer.x ?? ""}" placeholder="X" />
                  <input class="answer-y" data-day="${dayId}" type="number" value="${answer.y ?? ""}" placeholder="Y" />
                  <input class="answer-z" data-day="${dayId}" type="number" value="${answer.z ?? ""}" placeholder="Z" />
                </div>
                <button type="button" class="save-answer" data-day="${dayId}" style="margin-top:6px;">
                  Save answer
                </button>
              </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="day-config-col">
              <div>
                <div class="day-config-label">Screenshot URL (public image link) <i>recommended to use discord and copy link</i></div>
                <input class="image-url"
                       data-day="${dayId}"
                       type="text"
                       placeholder="https://example.com/challenge.png"
                       value="${imageUrl}" />
                <button type="button" class="button-ghost save-image-url" data-day="${dayId}" style="margin-top:6px;">
                  Save image URL
                </button>

                <img
                  class="day-config-image-preview image-preview"
                  data-day="${dayId}"
                  src="${imageUrl || ""}"
                  alt="Preview for ${labelForDay(dayId)}"
                  style="${imageUrl ? "" : "display:none;"}" />
              </div>
            </div>
          </div>
        `;

        dayConfigList.appendChild(row);
      });
    }

    onValue(ref(db, "days"), snap => {
      daysCache = snap.val() || {};
      renderDayConfig();
    });

    onValue(ref(db, "entries"), snap => {
      entriesCache = snap.val() || {};
      renderEntriesTable();
    });

    /* ---------- DAY CONFIG EVENTS ---------- */

    dayConfigList.addEventListener("click", async (e) => {
      const btn = e.target;
      const dayId = btn.getAttribute("data-day");
      if (!dayId) return;

      // Save answer
      if (btn.classList.contains("save-answer")) {
        const row = btn.closest(".table-row");
        const xVal = row.querySelector(".answer-x").value;
        const yVal = row.querySelector(".answer-y").value;
        const zVal = row.querySelector(".answer-z").value;

        const x = Number(xVal);
        const y = Number(yVal);
        const z = Number(zVal);

        if ([xVal, yVal, zVal].some(v => v === "") || [x,y,z].some(v => Number.isNaN(v))) {
          dayConfigMsg.textContent = `Please enter valid numbers for ${labelForDay(dayId)}.`;
          return;
        }

        await update(ref(db, `days/${dayId}`), { answer: { x, y, z }});
        dayConfigMsg.textContent = `Saved correct answer for ${labelForDay(dayId)}.`;
      }

      // Save image URL
      if (btn.classList.contains("save-image-url")) {
        const row = btn.closest(".table-row");
        const input = row.querySelector(".image-url");
        const url = input.value.trim();

        await update(ref(db, `days/${dayId}`), { imageUrl: url });
        dayConfigMsg.textContent = `Saved image URL for ${labelForDay(dayId)}.`;
      }
    });

    // Unlock toggle
    dayConfigList.addEventListener("change", async (e) => {
      const chk = e.target;
      if (!chk.classList.contains("day-unlock")) return;
      const dayId = chk.getAttribute("data-day");

      await update(ref(db, `days/${dayId}`), { unlocked: chk.checked });
      dayConfigMsg.textContent = `${labelForDay(dayId)} ${chk.checked ? "unlocked" : "locked"}.`;
    });

    // Live image preview while typing/pasting URL
    dayConfigList.addEventListener("input", (e) => {
      const input = e.target;
      if (!input.classList.contains("image-url")) return;

      const row = input.closest(".table-row");
      const preview = row.querySelector(".image-preview");
      if (!preview) return;

      const url = input.value.trim();
      if (url.startsWith("http")) {
        preview.src = url;
        preview.style.display = "block";
      } else {
        preview.style.display = "none";
      }
    });

    /* ---------- ENTRIES TABLE ---------- */

    function renderEntriesTable() {
    const dayId = entriesDaySelect.value || DAY_IDS[0];

    const entries = entriesCache[dayId] || {};
    const answer = (daysCache[dayId] || {}).answer;

    entriesTable.innerHTML = "";

    const keys = Object.keys(entries);
    if (!keys.length) {
        entriesTable.innerHTML = `<div class="no-data">No entries yet.</div>`;
        return;
    }

    // --- Calculate distances and sort by lowest distance ---
    const list = keys.map(k => {
        const e = entries[k];
        let dist = Infinity;

        if (answer && typeof answer.x === "number") {
        const dx = e.x - answer.x;
        const dy = e.y - answer.y;
        const dz = e.z - answer.z;
        dist = Math.sqrt(dx*dx + dy*dy + dz*dz);
        }

        return { ...e, dist, key: k };
    });

    // Sort by distance ascending
    list.sort((a, b) => a.dist - b.dist);

    // --- Build table header with RANK column ---
    const header = document.createElement("div");
    header.className = "table-header";
    header.innerHTML = `
        <div>Rank</div>
        <div>Username</div>
        <div>Guess (x, y, z)</div>
        <div>Distance</div>
        <div>Updated</div>
    `;
    entriesTable.appendChild(header);

    // --- Insert rows with ranking numbers ---
    list.forEach((entry, index) => {
        const rank = index + 1;

        const row = document.createElement("div");
        row.className = "table-row";
        row.style.padding = "8px 10px";

        row.innerHTML = `
        <div style="display:grid;grid-template-columns:0.6fr 1.5fr 1.4fr 1.2fr 1.4fr;gap:8px;font-size:0.9rem;">
            <div><strong>${rank}</strong></div>
            <div>${entry.username}</div>
            <div>${entry.x}, ${entry.y}, ${entry.z}</div>
            <div>${entry.dist === Infinity ? "No answer set" : entry.dist.toFixed(2) + " blocks"}</div>
            <div>${entry.updatedAt ? new Date(entry.updatedAt).toLocaleString() : ""}</div>
        </div>
        `;

        entriesTable.appendChild(row);
    });
    }

    entriesDaySelect.addEventListener("change", renderEntriesTable);

    /* ---------- DISTANCE CALCULATOR ---------- */

    distanceForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const dayId = calcDaySelect.value || DAY_IDS[0];

      const x = Number(document.getElementById("calcX").value);
      const y = Number(document.getElementById("calcY").value);
      const z = Number(document.getElementById("calcZ").value);

      if ([x,y,z].some(v => Number.isNaN(v))) {
        distanceResult.textContent = "Please enter valid coordinates.";
        return;
      }

      const snap = await get(ref(db, `days/${dayId}/answer`));
      const ans = snap.val();
      if (!ans || typeof ans.x !== "number") {
        distanceResult.textContent = `No answer set for ${labelForDay(dayId)}.`;
        return;
      }

      const d = distance3D({ x, y, z }, ans);
      distanceResult.textContent = `Distance from correct answer for ${labelForDay(dayId)}: ${d.toFixed(2)} blocks.`;
    });
  </script>
</body>
</html>
